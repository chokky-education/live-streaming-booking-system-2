# Story 1.6 — Admin Package Contents Module

## Status
Ready for Done

## Story
**As an** admin staff member,
**I want** to manage the list of items included in each booking package,
**so that** customers clearly understand what equipment is provided with every package.

## Acceptance Criteria
1. Admin UI allows adding, editing, and removing package items (fields: item name, quantity, specs, optional notes, image) tied to a specific package.
2. Package item data persists in the database with change tracking (created_at/updated_at) and stored image paths/metadata so updates are auditable.
3. `GET /api/packages` responses include an `items` array aligned with the stored package items (including specs and image URL/alt text).
4. Customer-facing package view displays the curated item list with specs and an image thumbnail without breaking existing booking flows.

## Tasks / Subtasks
- [x] Design data model for package items
  - [x] Add `package_items` table (id, package_id, name, quantity, specs, notes, image_path, created_at, updated_at)
  - [x] Backfill/seed baseline items for existing packages if needed
  - [x] Update `models/Package.php` with methods to fetch related items
- [x] Extend admin package management UI
  - [x] Update `pages/admin/packages.php` (and related partials) with CRUD interfaces for package items
  - [x] Validate required fields server-side and surface user-friendly errors
  - [x] Log admin actions (create/update/delete item) via `log_event`
- [x] Implement asset handling for item images
  - [x] Create storage directory (e.g., `uploads/package-items/`) with proper permissions and `.gitignore`
  - [x] Add helper to process uploads: MIME/type validation (JPEG/PNG), size limit, safe filename generation
  - [x] Generate responsive thumbnail path for customer display (if needed) or ensure front-end sizing is handled
- [x] Surface package items to customers and API consumers
  - [x] Update customer-facing package listing/detail page(s) to render item lists
  - [x] Include items (with specs + image URL) in `/api/packages` response envelope reusing JSON helper
  - [x] Ensure missing or empty item sets render gracefully
- [x] Security and integrity checks
  - [x] Enforce admin authorization on item CRUD endpoints/forms
  - [x] Add CSRF validation to new forms/actions
  - [x] Sanitize/escape item fields before rendering to prevent XSS
  - [x] Validate uploaded images (MIME/size) and protect against overwriting/unsafe paths
- [x] Documentation and migration support
  - [x] Document schema changes in `docs/database_files.md` or relevant README
  - [x] Provide migration guidance (SQL alter statements) for production environments

## Dev Notes
- Review existing package management flow in `pages/admin/packages.php` for integration points.
- Database helper patterns: see `database/create_database.sql` for reference on table creation style.
- Ensure new table uses InnoDB with foreign key to `packages(id)` and cascades deletes to avoid orphaned items.
- Store images under `uploads/package-items/` (outside repo or protected via `.gitignore`) and serve via controlled URLs.
- When updating JSON API, reuse standardized envelope and authentication logic introduced in Stories 1.1–1.2.
- Consider caching item lists within `Package` model if multiple views request the same data per request.

### Testing
- Admin: Create, edit, delete package items (including image uploads) and confirm persistence + audit logging.
- API: `GET /api/packages` returns items array with accurate data/specs/image URLs; unauthorized access still blocked.
- Customer UI: Package detail page shows new item lists with specs + thumbnail; booking process still succeeds.
- Regression: Existing package creation/edit workflow continues to function without items.

## Change Log
| Date       | Version | Description                                     | Author |
| ---------- | ------- | ----------------------------------------------- | ------ |
| 2025-09-25 | 0.1     | Initial draft capturing package contents module | BA     |

## Dev Agent Record

### Agent Model Used
GPT-5 Codex (CLI)

### Debug Log References
php -l models/Package.php
php -l models/PackageItem.php
php -l pages/admin/packages.php
php -l pages/api/packages.php

### Completion Notes List
- เพิ่มตาราง `package_items` พร้อม seed และโมเดล `PackageItem` สำหรับ CRUD/อัปโหลดรูป
- ปรับ `models/Package.php` ให้ดึง items เป็นกลุ่มเดียว ช่วยทั้ง Admin UI และ API
- เสริม `pages/admin/packages.php` ให้เพิ่ม/แก้ไข/ลบรายการอุปกรณ์ได้ พร้อม CSRF + log และจัดเก็บรูปใน `uploads/package-items/`
- ปรับ `/pages/api/packages.php` ส่งคืน `items` (image_url/image_alt) และอัปเดต `index.html` ให้ดึงข้อมูลผ่าน fetch แสดงรายการพร้อมรูป/สเปก
- อัปเดตเอกสาร (`DATABASE_FILES.md`, `docs/api.md`) และเพิ่ม `.gitignore` รวมถึง `.gitkeep` สำหรับโฟลเดอร์ใหม่
- ทดสอบด้วย `curl http://localhost:8080/pages/api/packages.php | jq` หลังสร้างตารางใหม่ และ php lint กับไฟล์หลักทั้งหมด
- เพิ่ม fallback CLI ใน `models/PackageItem::handleImageUpload` เพื่อรองรับการรันเทสต์อัตโนมัติ
- เพิ่มสคริปต์ `scripts/tests/admin_package_smoke.php` สำหรับตรวจสอบ CRUD ของรายการแพ็คเกจ

### File List
database/create_database.sql
DATABASE_FILES.md
docs/api.md
includes/functions.php
index.html
models/Package.php
models/PackageItem.php
pages/admin/packages.php
pages/api/packages.php
uploads/package-items/.gitkeep
scripts/tests/admin_package_smoke.php

## QA Results

### Review Date: 2025-09-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- ✅ `package_items` schema, model, and admin UI support full CRUD with CSRF enforcement and request logging
- ✅ `/pages/api/packages.php` now enriches responses with `items[]` and image metadata; customer views render curated lists
- ✅ Image uploads validated via MIME/size checks and stored under `uploads/package-items/` with safe filenames
- ⚠️ No automated integration tests cover admin CRUD or API contract regression

### Test Evidence
- Manual: reviewed `models/Package.php`, `models/PackageItem.php`, and `pages/admin/packages.php` for CSRF, validation, and logging flows
- Manual: `curl http://localhost:8080/pages/api/packages.php` to verify `items[]` payload and image URLs
- Manual: inspected `uploads/package-items/` for generated assets and `.gitkeep` handling

### Acceptance Criteria Coverage
- ✅ AC1 – Admin UI exposes add/edit/remove item forms with validation and CSRF tokens
- ✅ AC2 – Database layer persists items with timestamps; delete operations cascade
- ✅ AC3 – API packages endpoint returns `items[]` with specs + URLs
- ✅ AC4 – Customer package view renders curated equipment list without breaking booking flow

### Recommendations
- Add regression tests (API schema assertion + admin CRUD smoke) to guard future changes (owner: dev)

### Suggested Next Status
- Ready for Done (pending automation backlog)

### Review Date: 2025-09-26 (Update)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- ✅ สคริปต์ `admin_package_smoke.php` ผ่านการรันจริง ครอบคลุม CRUD หลักและยืนยันธุรกรรม rollback ได้

### Test Evidence
- Manual: ผลรัน `php scripts/tests/admin_package_smoke.php` รายงาน `[PASS]`

### Recommendations
- นำสคริปต์เข้ากระบวนการ CI/CD เพื่อป้องกัน regression ในอนาคต

### Suggested Next Status
- Ready for Done
