# Story 1.4 — Payment Submission and Verification Endpoints

## Status
Ready for Review

## Story
**As a** user/admin,
**I want** to submit payment slip metadata and verify/reject payments via API,
**so that** the payment workflow can be managed programmatically.

## Acceptance Criteria
1. `POST /api/payments` (user) accepts JSON metadata (booking_code or booking_id, amount, payment_method, transaction_ref, notes) and creates a payment with status `pending`. Returns 201 with payment id.
2. `PATCH /api/payments/{id}` (admin) updates status to `verified` or `rejected`, sets `verified_by` and `verified_at`. Returns 200 with updated record.
3. Authorization enforced: user can only create for own booking; admin-only verification. Unauthorized returns 401/403 JSON error.
4. Responses use standard envelope; errors include appropriate HTTP statuses (400/401/403/404/409/500).
5. No regressions to existing backoffice payment pages.

## Tasks / Subtasks
- [x] Endpoint: Create payment (user)
  - [x] Create `pages/api/payments.php` (handle `POST`) include `includes/config.php`
  - [x] Require login; validate payload; resolve booking by code/id and ownership
  - [x] Insert payment via `Payment` model (status `pending`)
  - [x] Return 201 with `{ id, booking_id, status }`
- [x] Endpoint: Verify/reject payment (admin)
  - [x] Create `pages/api/payments_update.php` handling `PATCH` (or `POST` with `_method=PATCH`), include `includes/config.php`
  - [x] Require admin; update fields `status`, `verified_by`, `verified_at`
  - [x] Return 200 with updated payment
- [x] Authorization & validation
  - [x] Ensure user owns the booking when creating payments
  - [x] Enforce admin-only on verification
- [x] Standard behaviors
  - [x] Use envelope and error helper
  - [x] Log actions with request ID, actor, booking/payment ids
- [x] Docs & examples
  - [x] Add curl examples for POST and PATCH

## Dev Notes
- Models: `models/Payment.php:1`, `models/Booking.php:1`
- Ownership check: fetch booking by code/user to match `$_SESSION['user_id']`
- Admin check: `is_admin()` from `includes/config.php`
- For actual file uploads, current flow remains page-based; this story focuses on metadata and verification

### Testing
- User creates payment for own booking → 201
- User attempts for another user's booking → 403
- Admin verifies payment → 200; sets verifier fields
- Unauthorized/forbidden flows return 401/403 JSON errors

## Change Log
| Date       | Version | Description                          | Author       |
| ---------- | ------- | ------------------------------------ | ------------ |
| 2025-09-25 | 0.1     | Initial draft from PRD Story 1.4     | Scrum Master |

## Dev Agent Record

### Agent Model Used
GPT-5 Codex (CLI)

### Debug Log References
php -l pages/api/payments.php
php -l pages/api/payments_update.php

### Completion Notes List
- ตรวจสอบ flow การสร้าง payment ตรวจสิทธิ์ booking และบังคับ CSRF/session
- ยืนยัน endpoint สำหรับแอดมินรองรับ PATCH (หรือ POST+_method) และอัปเดต verified_by/verified_at
- ทบทวน `docs/api.md` มีตัวอย่าง curl สำหรับ POST/ PATCH payment ตามเกณฑ์
- ทดสอบ `curl` POST `/pages/api/payments.php` (201) และ PATCH `/pages/api/payments_update.php` (200) ยืนยันสร้าง/verify payment ด้วย session + CSRF

### File List
pages/api/payments.php
pages/api/payments_update.php
docs/api.md

## QA Results
