# Story 1.2 — Read Endpoints for Packages and User Bookings

## Status
Ready for Review

## Story
**As an** authenticated user,
**I want** to fetch available packages and my bookings via JSON,
**so that** I can build or test clients programmatically.

## Acceptance Criteria
1. `GET /api/packages` returns only active packages with fields: id, name, description, price, equipment_list, image_url. HTTP 200.
2. `GET /api/bookings/me` returns bookings for the authenticated user ordered by created_at desc. HTTP 200.
3. Unauthenticated requests to `/api/bookings/me` return HTTP 401 with `{ success: false, error: { code: 'UNAUTHORIZED', message } }`.
4. Responses use the standard envelope `{ success, data, error }`. Errors include appropriate HTTP status codes.
5. No regressions to existing page flows.

## Tasks / Subtasks
- [x] Endpoint: List active packages
  - [x] Create `pages/api/packages.php` (include `includes/config.php`)
  - [x] Use `Package->getActivePackages()` and return JSON via helper
  - [x] Map equipment_list JSON to native array in response
- [x] Endpoint: List current user bookings
  - [x] Create `pages/api/bookings_me.php` (include `includes/config.php`)
  - [x] Require session auth; if not logged in, return 401 JSON error
  - [x] Use `Booking->getUserBookings($_SESSION['user_id'])`
- [x] Standard behaviors
  - [x] Use success/error JSON envelope consistently
  - [x] Add simple request ID and log calls via `log_event`
  - [x] Ensure correct headers (`Content-Type: application/json`)
- [x] Docs & verification
  - [x] Add short API usage examples to docs (curl samples)
  - [x] Verify DB indices used (status/date where relevant); no full scans expected

## Dev Notes
- Reuse bootstrap and helpers: `includes/config.php:1`, `includes/functions.php:1`
- Models: `models/Package.php:1` (`getActivePackages`), `models/Booking.php:1` (`getUserBookings`)
- Auth check: `is_logged_in()` from `includes/config.php`
- Envelope and logging as in Story 1.1

### Testing
- `curl -s http://<host>/pages/api/packages.php`
- `curl -s --cookie "PHPSESSID=..." http://<host>/pages/api/bookings_me.php`
- Without auth to bookings endpoint returns 401 JSON error

## Change Log
| Date       | Version | Description                          | Author       |
| ---------- | ------- | ------------------------------------ | ------------ |
| 2025-09-25 | 0.1     | Initial draft from PRD Story 1.2     | Scrum Master |

## Dev Agent Record

### Agent Model Used
GPT-5 Codex (CLI)

### Debug Log References
php -l pages/api/packages.php
php -l pages/api/bookings_me.php

### Completion Notes List
- ตรวจสอบว่าทั้งสอง endpoint ใช้ envelope มาตรฐานและบันทึก log พร้อม request ID
- ยืนยัน `getUserBookings` คืนข้อมูลเรียงตาม `created_at DESC`
- ตรวจดู `docs/api.md` มีตัวอย่าง curl สำหรับ packages และ bookings
- ทดสอบ `curl` กับ `/pages/api/packages.php` (200) และ `/pages/api/bookings_me.php` ทั้งกรณีไม่ล็อกอิน (401) และล็อกอินด้วย session

### File List
pages/api/packages.php
pages/api/bookings_me.php
docs/api.md

## QA Results
