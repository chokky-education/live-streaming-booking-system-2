# Story 1.3 — Create Booking Endpoint with Validation and Availability

## Status
Ready for Review

## Story
**As an** authenticated user,
**I want** to create a booking through the API,
**so that** I can integrate programmatically while enforcing business rules.

## Acceptance Criteria
1. `POST /api/bookings` accepts JSON payload: { package_id, pickup_date (YYYY-MM-DD), return_date (YYYY-MM-DD), pickup_time (HH:MM), return_time (HH:MM), location, notes } and validates input.
2. CSRF protection enforced for state-changing request (token via header or form field), and session auth required.
3. Availability checked via `Booking->checkPackageAvailability`; if unavailable, respond 409 with `{ success: false, error: { code: 'AVAILABILITY_CONFLICT', ... } }`.
4. On success, create booking with status `pending`, return 201 and `{ success: true, data: { booking_code, id, rental_days, pickup_date, return_date, total_price, status } }` including pricing breakdown.
5. Errors use standard envelope with appropriate HTTP statuses (400 validation, 401 unauthorized, 409 conflict, 500 internal).

## Tasks / Subtasks
- [x] Endpoint: Create booking
  - [x] Create `pages/api/bookings.php` handling `POST` only (include `includes/config.php`)
  - [x] Require login; verify CSRF via `verify_csrf_token`
  - [x] Parse JSON body; sanitize fields; reuse `Booking->validate($data)`
  - [x] Check availability; load package via `Package->getById` and compute total (reuse `Package` pricing approach seen in `pages/booking.php`)
  - [x] Populate `Booking` model and call `create()`; return JSON success with booking_code
  - [x] Log success/error with request ID
- [x] Error handling
  - [x] Map validation errors to 400; CSRF/auth errors to 401; availability to 409
  - [x] Use consistent error codes/messages
- [x] Docs & examples
  - [x] Document JSON schema and example requests/responses in docs

## Dev Notes
- Reference implementation flow: `pages/booking.php: form handling & validation`
- Models: `models/Booking.php:1`, `models/Package.php:1`
- Helpers: `sanitize_input`, `verify_csrf_token`, `json_response`, `log_event`
- Ensure time/date validation aligns with `Booking->validate`

### Testing
- Success: valid payload with available package returns 201 and booking_code
- Validation: past date or start>=end returns 400
- Availability: booking conflict returns 409
- Auth/CSRF: missing session or token returns 401

## Change Log
| Date       | Version | Description                          | Author       |
| ---------- | ------- | ------------------------------------ | ------------ |
| 2025-09-25 | 0.1     | Initial draft from PRD Story 1.3     | Scrum Master |

## Dev Agent Record

### Agent Model Used
GPT-5 Codex (CLI)

### Debug Log References
php -l pages/api/bookings.php

### Completion Notes List
- ตรวจสอบ flow CSRF + session ก่อนสร้าง booking และยืนยัน mapping error codes
- ยืนยัน `Booking->validate`/`checkPackageAvailability` ถูกเรียกก่อนสร้างจริง และใช้ `Booking->calculatePricingBreakdown` สำหรับคำนวณราคา
- ตรวจเอกสาร `docs/api.md` มีตัวอย่าง POST booking พร้อม payload/headers
- ทดสอบ `curl` POST `/pages/api/bookings.php` (201) ด้วย session + CSRF token ยืนยันสร้าง booking_code สำเร็จ

### File List
pages/api/bookings.php
docs/api.md

## QA Results
