# Story 1.9 — Ledger Cleanup Automation

## Status
Ready for Done

## Story
**As an** operations engineer,
**I want** the equipment availability ledger to clean itself up after bookings finish and to alert me about orphaned entries,
**so that** the availability calendar stays accurate without manual intervention.

## Acceptance Criteria
1. A scheduled cleanup job removes ledger rows tied to bookings whose status is `completed` or `cancelled` beyond a configurable retention window (default 30 days).
2. The cleanup process identifies and reports orphaned ledger rows (no booking reference) via log/notification so the team can investigate anomalies.
3. Running the cleanup job is idempotent and safe to execute multiple times without side effects.
4. Operational documentation explains how to run the job manually and how to deploy it as a cron/task runner in production.

## Tasks / Subtasks
- [x] Implement ledger cleanup command/job
  - [x] Create CLI/cron-friendly script that deletes stale ledger rows by booking status + age
  - [x] Make retention window configurable via environment or config
- [x] Orphan detection & reporting
  - [x] Query ledger for rows lacking bookings (or referencing inactive bookings) and log results with counts + sample ids
  - [x] Optionally raise alerts (e.g., log severity) when orphan count > 0
- [x] Safeguards & monitoring
  - [x] Ensure job logs summary of deletions/orphans and execution time
  - [x] Add metrics hook or placeholder for future observability integration
- [x] Documentation & rollout
  - [x] Add README/operations section describing job usage and scheduling
  - [x] Update PRD/architecture to record cleanup/maintenance expectation

## Dev Notes
- Reuse existing DB utilities for iterating bookings; prefer batched deletes to avoid locking large ranges.
- Consider wrapping deletes in transactions per batch to minimise lock duration.
- Keep job implementation compatible with shared hosting / cron contexts where PHP CLI runs via `php scripts/cleanup_ledger.php`.

### Testing
- Automated/unit: run job against seeded data (mix of active/completed/cancelled) and assert results.
- Manual: simulate orphaned ledger entries and confirm job logs warnings without deleting them (unless design says otherwise).
- Regression: confirm active bookings retain ledger rows.

## Change Log
| Date       | Version | Description                                 | Author |
| ---------- | ------- | ------------------------------------------- | ------ |
| 2025-09-27 | 0.1     | Draft story for automated ledger maintenance | PO     |

## Dev Agent Record

### Agent Model Used
GPT-5 Codex (CLI)

### Debug Log References
- php -l scripts/cleanup_ledger.php
- php -l includes/config.php
- php -l README.md (N/A)

### Completion Notes List
- เพิ่มคอนฟิก `LEDGER_CLEANUP_RETENTION_DAYS` (อ่านจาก env `LEDGER_RETENTION_DAYS`) เพื่อควบคุมระยะเวลาเก็บ ledger
- สร้างสคริปต์ `scripts/cleanup_ledger.php` รองรับ `--retention`, `--dry-run`, `--verbose`, ลบทีละชุดและบันทึก log สรุป
- รายงาน orphan ledger ผ่าน log warning พร้อม sample และรองรับ dry-run
- อัปเดต README/Architecture ให้ระบุวิธีใช้งาน job และคำแนะนำการตั้ง cron/snapshot
- สคริปต์ใช้เวลารันพร้อมแสดงผลลัพธ์ทาง STDOUT และบันทึก log_event สำหรับการมอนิเตอร์
