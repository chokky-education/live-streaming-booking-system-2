# Story 1.1 — API Scaffolding and Response Envelope

## Status
Ready for Review

## Story
**As a** developer,
**I want** a namespaced `/api` with a standard JSON response wrapper,
**so that** future endpoints are consistent and easy to consume.

## Acceptance Criteria
1. `GET /api/health` returns `{ success: true, data: { status: 'ok' } }` with HTTP 200.
2. Shared JSON helper is used; errors return `{ success: false, error: { code, message } }` with appropriate HTTP status.
3. Existing pages continue to function with no regressions; adding API causes no routing conflicts.

## Tasks / Subtasks
- [x] Create API namespace and health endpoint
  - [x] Create `pages/api/` (or `api/`) directory for API scripts
  - [x] Add `pages/api/health.php` that includes `includes/config.php` and returns JSON using shared helper
  - [x] Ensure output follows `{ success, data, error }` envelope
- [x] Standardize JSON response/error handling
  - [x] Reuse `includes/functions.php::json_response($data, $status_code)` for success paths
  - [x] Add helper for error responses (wrapper that calls `json_response` with structure `{ success: false, error: { code, message } }`)
  - [x] Centralize common headers (e.g., `Content-Type: application/json`)
- [x] Logging and request correlation
  - [x] Generate a simple request ID per API request; include in logs via `log_event`
  - [x] Log API health calls with level INFO and errors with level ERROR
- [x] Non-regression and routing
  - [x] Verify `index.php` redirect and existing pages are unaffected
  - [x] Confirm web server config maps `/pages/api/*.php` to `/api/*` path as expected in this environment (or document access URL pattern)
- [x] Documentation
  - [x] Update `docs/` with a brief API README snippet (endpoint list, example response)

## Dev Notes
- Architecture reference: See `docs/brownfield-architecture.md:1` (High-Level Architecture, Module Overview, Development & Runbook).
- Existing helpers to reuse
  - Config & session: `includes/config.php:1` (starts session, constants, CSRF helpers)
  - JSON response: `includes/functions.php:json_response($data, $status_code = 200)` sets status code and `Content-Type: application/json`
  - Logging: `includes/functions.php:log_event($message, $level = 'INFO')` writes to `logs/system.log`
- Envelope pattern
  - Success example: `{ "success": true, "data": { "status": "ok" } }`
  - Error example: `{ "success": false, "error": { "code": "INTERNAL_ERROR", "message": "..." } }`
- Security
  - Health endpoint is read-only and public; no CSRF needed
  - For future state-changing endpoints, ensure CSRF verification via `verify_csrf_token()` and session auth
- Paths and runtime
  - Place API scripts under `pages/api/` to align with current project structure
  - Include `includes/config.php` at top of API scripts for consistent bootstrap

### Testing
- Manual checks
  - `curl -i http://<host>/pages/api/health.php` (or mapped `/api/health`) returns 200 and JSON structure
  - Force an internal error (temporary) to observe `{ success: false, error: ... }` shape and log entry
- Non-regression
  - Navigate to `index.html`, login, booking flow to ensure no breakage

## Change Log
| Date       | Version | Description                                   | Author        |
| ---------- | ------- | --------------------------------------------- | ------------- |
| 2025-09-25 | 0.1     | Initial draft created from PRD Epic 1 Story 1 | Scrum Master  |

## Dev Agent Record

### Agent Model Used
GPT-5 Codex (CLI)

### Debug Log References
php -l includes/functions.php
php -l pages/api/health.php

### Completion Notes List
- ยืนยัน endpoint `/pages/api/health.php` ตอบซอง `{success,data}` และบันทึก log พร้อม request ID
- ตรวจสอบ helper `api_success`/`api_error` และ `init_request_id` ใน `includes/functions.php`
- ทบทวน `docs/api.md` มีตัวอย่าง health endpoint ตามเกณฑ์
- ทดสอบจริงด้วย `curl http://localhost:8080/pages/api/health.php` ได้ HTTP 200 และ JSON `{success:true}`

### File List
includes/functions.php
pages/api/health.php
docs/api.md

## QA Results
