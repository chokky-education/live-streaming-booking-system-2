# Story 1.8 — Booking Concurrency Hardening

## Status
Ready for Review

## Story
**As an** operations manager,
**I want** booking creation to run inside a safe database transaction with capacity-aware locking and diagnostic logging,
**so that** simultaneous customers cannot overbook a package and the team can trace when capacity limits are hit.

## Acceptance Criteria
1. Booking creation (web + API) wraps availability check and persistence in a single transaction and uses row-level locking so two requests cannot reserve the same capacity simultaneously.
2. When a booking request is rejected because the capacity for the selected dates is full, the system logs a structured warning that includes package_id, date range, user_id (if known), and the detected usage vs capacity.
3. All existing unit/integration tests for booking still pass, and new concurrency-focused tests cover the transaction path (at least one simulated parallel request scenario).
4. No regression to booking success path: legitimate single-request bookings still complete and redirect to payment as before.

## Tasks / Subtasks
- [x] Implement transaction + locking for booking create
  - [x] Update `models/Booking::create()` (and related API handler) to open a transaction and lock rows needed for availability checks
  - [x] Ensure capacity re-check occurs inside the transaction prior to insert
  - [x] Handle rollback/commit and surface user-friendly messages on conflict
- [x] Add conflict logging & observability
  - [x] Emit `log_event` warnings when capacity is exceeded, with metadata (package, date window, usage, capacity, user)
  - [x] Add dashboard-friendly log message format for later ingestion/alerts
- [x] Strengthen automated test coverage
  - [x] Add concurrency test helper (e.g., helper script or PHPUnit scenario) simulating multiple booking attempts in parallel
  - [x] Validate expected success/failure counts when capacity is limited
- [x] Documentation & deployment notes
  - [x] Update PRD/architecture to reflect new concurrency safeguards
  - [x] Provide guidance for DB environments that need transaction isolation tweaks (if any)

## Dev Notes
- Coordinate with DB admin on isolation level requirements; `SELECT ... FOR UPDATE` may need explicit indexes.
- Consider wrapping availability ledger writes in the same transaction to maintain atomicity.
- Reuse existing error envelope patterns on API side to expose `AVAILABILITY_CONFLICT` while logging the warning.
- Keep logging lightweight (JSON or key-value) to simplify parsing with future monitoring tools.

### Testing
- Automated: run new concurrency-focused test suite/script and ensure deterministic outcomes.
- Manual: attempt simultaneous bookings (browser + curl) for the same package/dates and confirm only capacity-allowed number succeed.
- Regression: smoke test standard booking flow (single user) to ensure no new errors.

## Change Log
| Date       | Version | Description                               | Author |
| ---------- | ------- | ----------------------------------------- | ------ |
| 2025-09-27 | 0.1     | Draft story for booking concurrency lock  | PO     |

## Dev Agent Record

### Agent Model Used
GPT-5 Codex (CLI)

### Debug Log References
- php -l models/Booking.php
- php -l pages/booking.php
- php -l pages/api/bookings.php
- php -l scripts/tests/booking_concurrency_smoke.php

### Completion Notes List
- ล้อม transaction ใน `models/Booking::create()` พร้อมล็อกแถว package และ re-check ความจุภายใน transaction
- เพิ่มการบันทึก warning เมื่อเต็มความจุ พร้อม metadata usage/capacity และรายงานผ่านหน้าเว็บ/API ด้วย error code ใหม่
- อัปเดตหน้า booking และ API ให้แสดงข้อความเมื่อความจุเต็มและใช้ `error_code` สำหรับการตอบกลับ 409
- สร้างสคริปต์ `scripts/tests/booking_concurrency_smoke.php` จำลองการจองพร้อมกันเพื่อยืนยันว่าไม่เกิน capacity
- เอกสาร PRD/Architecture (อัปเดตแล้ว) ครอบคลุมข้อกำหนดเรื่อง concurrency/locking เพื่อรองรับงานนี้

### File List
- models/Booking.php
- pages/booking.php
- pages/api/bookings.php
- scripts/tests/booking_concurrency_smoke.php

## QA Results

### Review Date: 2025-09-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- ตรวจสอบโค้ดใหม่ใน `models/Booking::create()` ยืนยันว่าการล็อก `FOR UPDATE` และ re-check ความจุอยู่ภายใน transaction และคืนค่า `error_code` ที่ UI/API นำไปใช้ได้
- `logCapacityWarning()` ให้ metadata ครบถ้วนและถูกเรียกทั้งฝั่งหน้าเว็บและ API ไม่มี side effect เพิ่มเติม
- `getReservationUsageMap()` รองรับ fallback ledger และล็อกข้อมูลเมื่อร้องขอแบบ concurrent
- ไม่พบปัญหาด้าน performance หรือ security จากการเปลี่ยนแปลงนี้

### Test Evidence
- `php -l models/Booking.php`
- `php -l pages/booking.php`
- `php -l pages/api/bookings.php`
- `php -l scripts/tests/booking_concurrency_smoke.php`
- `php scripts/tests/booking_concurrency_smoke.php 1 2025-10-18 2025-10-19 6` → สำเร็จ 5 คิว/ชนกัน 1 คิว (เท่ากับ capacity) พร้อมแจ้งเตือน cleanup warning ที่ไม่กระทบผลลัพธ์ทดสอบ

### Issues / Risks
- ไม่พบประเด็นความเสี่ยงเพิ่มเติม

### Recommended Status
- Ready for Done
